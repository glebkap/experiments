# Алгоритм поиска дверей и окон на планах зданий

## Общее описание

Алгоритм предназначен для обнаружения, маркировки и подсчета дверей и окон на планах зданий с использованием методов компьютерного зрения. Алгоритм построен на основе комбинации методов обнаружения и сопоставления признаков (ORB) и шаблонного сопоставления.

## Этапы алгоритма

### 1. Предварительная обработка входного изображения

- Загрузка изображения плана здания в формате JPG или PNG
- Преобразование в оттенки серого для упрощения последующей обработки

Минималистичный подход к предварительной обработке выбран в результате экспериментов, которые показали, что дополнительные этапы обработки (такие как бинаризация или выделение краев) не улучшают результаты, но увеличивают время выполнения и могут вносить нежелательные искажения.

### 2. Подготовка эталонных образцов

- Загрузка и предобработка эталонных изображений дверей из директории `data/doors`
- Загрузка и предобработка эталонных изображений окон из директории `data/windows`
- Нормализация размеров и форматов эталонных изображений
- Извлечение ключевых характеристик эталонных объектов для последующего сравнения

### 3. Поиск объектов на изображении

#### Метод 1: Обнаружение признаков с использованием ORB

- Использование алгоритма ORB (Oriented FAST and Rotated BRIEF) для обнаружения ключевых точек и их дескрипторов на изображении в оттенках серого
- Сопоставление дескрипторов между эталонными образцами и планом здания с использованием KNN (k-ближайших соседей)
- Применение теста отношения Лоу (Lowe's ratio test) для фильтрации соответствий
- Фильтрация соответствий и применение порога для определения хороших соответствий
- Оценка геометрического преобразования (гомография) между эталоном и найденной областью
- Вычисление ограничивающего прямоугольника для каждого обнаруженного объекта
- **Преимущество**: инвариантность к повороту, что позволяет обнаруживать окна и двери независимо от их ориентации

#### Метод 2: Шаблонное сопоставление (Template Matching)

- Применение алгоритма `cv2.matchTemplate` непосредственно к изображению в оттенках серого для каждого эталонного образца
- Использование метрики нормализованной кросс-корреляции (`cv2.TM_CCOEFF_NORMED`) для сопоставления
- Установка порога соответствия для фильтрации результатов с низкой уверенностью
- Обработка пересекающихся обнаружений с помощью алгоритма подавления немаксимумов (NMS)
- **Преимущество**: высокая точность при детектировании объектов в стандартной ориентации

### 4. Постобработка и уточнение результатов

- Объединение результатов, полученных разными методами (ORB и шаблонное сопоставление)
- Устранение дублирующих обнаружений с использованием усовершенствованного алгоритма NMS (Non-Maximum Suppression)
- Фильтрация обнаружений по уровню уверенности (confidence)
- Вычисление метрики IoU (Intersection over Union) для определения перекрывающихся детекций

В процессе постобработки особое внимание уделяется корректному объединению результатов разных методов, что позволяет компенсировать недостатки каждого метода и использовать их сильные стороны.

### 5. Маркировка и классификация объектов

- Визуализация результатов на исходном изображении плана:
  - Обозначение дверей красным цветом
  - Обозначение окон синим цветом
- Присвоение уникальных идентификаторов каждому обнаруженному объекту с использованием UUID
- Добавление меток с типом объекта и номером (дверь/окно)
- Отображение информации о типе шаблона, если доступно

### 6. Формирование отчета

- Подсчет общего количества обнаруженных дверей
- Подсчет общего количества обнаруженных окон
- Сохранение размеченного изображения с выделенными объектами в директорию `results`
- Вывод статистики по обнаруженным объектам на итоговом изображении
- В режиме отладки - сохранение промежуточных результатов в директорию `results/debug`

## Особенности реализации

- Использование библиотеки OpenCV для обработки изображений
- Минималистичный подход к предварительной обработке, обеспечивающий баланс между скоростью и точностью
- Реализация с учетом архитектурных принципов, описанных в документации проекта
- Разделение на доменные слои и usecase в соответствии с принятой структурой
- Режим отладки (--debug) для сохранения и визуализации всех промежуточных этапов работы алгоритма
- Учет требований по производительности (обработка одного изображения не более 10 секунд)
- Обеспечение точности распознавания не менее 90%
- Обеспечение инвариантности к повороту для обнаружения объектов в различных ориентациях

## Параметры алгоритма

### Параметры алгоритма ORB

- `orb_features` - максимальное количество ключевых точек для обнаружения (по умолчанию 1000)
- `orb_scale_factor` - коэффициент масштабирования пирамиды (по умолчанию 1.2)
- `orb_levels` - количество уровней пирамиды (по умолчанию 8)
- `orb_min_matches` - минимальное количество хороших соответствий для подтверждения объекта (по умолчанию 10)
- `orb_match_ratio` - пороговое отношение для теста Лоу при KNN-сопоставлении (по умолчанию 0.75)

### Параметры шаблонного сопоставления

- `template_matching_threshold` - порог соответствия для шаблонного сопоставления (по умолчанию 0.7)
- `nms_threshold` - порог IoU для NMS алгоритма при фильтрации перекрывающихся детекций (по умолчанию 0.3)
- `duplicate_iou_threshold` - порог IoU для определения дублирующихся обнаружений (по умолчанию 0.3)

### Параметры отладки

- `debug` - флаг для включения режима отладки (по умолчанию False)

## Возможные улучшения

- Эксперименты с различными методами предобработки изображений, такими как адаптивная бинаризация, морфологические операции или контрастирование
- Исследование эффективности разных вариантов обнаружения краев (Canny, Sobel, Laplacian)
- Применение методов машинного обучения для повышения точности распознавания:
  - Сверточные нейронные сети (CNN) для детекции объектов
  - Faster R-CNN или YOLO для обнаружения дверей и окон на планах
- Оптимизация алгоритмов для ускорения обработки больших планов
- Реализация пакетной обработки нескольких планов одновременно
- Добавление возможности распознавания других архитектурных элементов (лестницы, мебель)
- Расширение возможностей постобработки для улучшения визуализации результатов
- Использование других алгоритмов, инвариантных к повороту (SIFT, SURF) для сравнения эффективности
